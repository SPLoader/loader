/*
** File: loader/i386-pc/idt/stubs.S
**
** Author: Brennan Ringey
**
*/

    .globl IDT_ISR_TABLE

__idt_isrSave:
    pusha
    pushl   %ds
    pushl   %es
    pushl   %fs
    pushl   %gs
    pushl   %ss

/*
** Stack contents (all 32-bit longwords) and offsets from ESP:
**
**   SS GS FS ES DS EDI ESI EBP ESP EBX EDX ECX EAX vec cod EIP CS EFL
**   0  4  8  12 16 20  24  28  32  36  40  44  48  52  56  60  64 68
**
** Note that the saved ESP is the contents before the PUSHA.
**
** Set up parameters for the ISR call.
*/

    movl    52(%esp), %eax
    movl    56(%esp), %ebx

    pushl   %ebx                    // put them on the stack as parameters to
    pushl   %eax                    // to the ISR

    movl    IDT_ISR_TABLE(,%eax,4), %ebx
    call    *%ebx
    addl    $8, %esp                // pop the parameters

__idt_isrRestore:
/*
** Restore the context
*/
    popl    %ss
    popl    %gs
    popl    %fs
    popl    %es
    popl    %ds
    popa
    addl    $8, %esp                // discard error code and vector
    iret                            // return from interrupt

// STUB Macros

#define ISR(vector) \
    .globl __idt_isr_##vector ; \
__idt_isr_##vector:           ; \
    pushl   $0                ; \
    pushl   $vector           ; \
    jmp     __idt_isrSave

#define ERR_ISR(vector) \
    .globl __idt_isr_##vector ; \
__idt_isr_##vector:           ; \
    pushl   $vector           ; \
    jmp     __idt_isrSave

// STUBS

ISR(0x00);      ISR(0x01);      ISR(0x02);      ISR(0x03);
ISR(0x04);      ISR(0x05);      ISR(0x06);      ISR(0x07);
ERR_ISR(0x08);  ISR(0x09);      ERR_ISR(0x0A);  ERR_ISR(0x0B);
ERR_ISR(0x0C);  ERR_ISR(0x0D);  ERR_ISR(0x0E);  ISR(0x0F);
ISR(0x10);      ERR_ISR(0x11);  ISR(0x12);      ISR(0x13);
ISR(0x14);      ISR(0x15);      ISR(0x16);      ISR(0x17);
ISR(0x18);      ISR(0x19);      ISR(0x1A);      ISR(0x1B);
ISR(0x1C);      ISR(0x1D);      ISR(0x1E);      ISR(0x1F);
ISR(0x20);      ISR(0x21);      ISR(0x22);      ISR(0x23);
ISR(0x24);      ISR(0x25);      ISR(0x26);      ISR(0x27);
ISR(0x28);      ISR(0x29);      ISR(0x2A);      ISR(0x2B);
ISR(0x2C);      ISR(0x2D);      ISR(0x2E);      ISR(0x2F);
ISR(0x30);      ISR(0x31);      ISR(0x32);      ISR(0x33);
ISR(0x34);      ISR(0x35);      ISR(0x36);      ISR(0x37);
ISR(0x38);      ISR(0x39);      ISR(0x3A);      ISR(0x3B);
ISR(0x3C);      ISR(0x3D);      ISR(0x3E);      ISR(0x3F);
ISR(0x40);      ISR(0x41);      ISR(0x42);      ISR(0x43);
ISR(0x44);      ISR(0x45);      ISR(0x46);      ISR(0x47);
ISR(0x48);      ISR(0x49);      ISR(0x4A);      ISR(0x4B);
ISR(0x4C);      ISR(0x4D);      ISR(0x4E);      ISR(0x4F);
ISR(0x50);      ISR(0x51);      ISR(0x52);      ISR(0x53);
ISR(0x54);      ISR(0x55);      ISR(0x56);      ISR(0x57);
ISR(0x58);      ISR(0x59);      ISR(0x5A);      ISR(0x5B);
ISR(0x5C);      ISR(0x5D);      ISR(0x5E);      ISR(0x5F);
ISR(0x60);      ISR(0x61);      ISR(0x62);      ISR(0x63);
ISR(0x64);      ISR(0x65);      ISR(0x66);      ISR(0x67);
ISR(0x68);      ISR(0x69);      ISR(0x6A);      ISR(0x6B);
ISR(0x6C);      ISR(0x6D);      ISR(0x6E);      ISR(0x6F);
ISR(0x70);      ISR(0x71);      ISR(0x72);      ISR(0x73);
ISR(0x74);      ISR(0x75);      ISR(0x76);      ISR(0x77);
ISR(0x78);      ISR(0x79);      ISR(0x7A);      ISR(0x7B);
ISR(0x7C);      ISR(0x7D);      ISR(0x7E);      ISR(0x7F);
ISR(0x80);      ISR(0x81);      ISR(0x82);      ISR(0x83);
ISR(0x84);      ISR(0x85);      ISR(0x86);      ISR(0x87);
ISR(0x88);      ISR(0x89);      ISR(0x8A);      ISR(0x8B);
ISR(0x8C);      ISR(0x8D);      ISR(0x8E);      ISR(0x8F);
ISR(0x90);      ISR(0x91);      ISR(0x92);      ISR(0x93);
ISR(0x94);      ISR(0x95);      ISR(0x96);      ISR(0x97);
ISR(0x98);      ISR(0x99);      ISR(0x9A);      ISR(0x9B);
ISR(0x9C);      ISR(0x9D);      ISR(0x9E);      ISR(0x9F);
ISR(0xA0);      ISR(0xA1);      ISR(0xA2);      ISR(0xA3);
ISR(0xA4);      ISR(0xA5);      ISR(0xA6);      ISR(0xA7);
ISR(0xA8);      ISR(0xA9);      ISR(0xAA);      ISR(0xAB);
ISR(0xAC);      ISR(0xAD);      ISR(0xAE);      ISR(0xAF);
ISR(0xB0);      ISR(0xB1);      ISR(0xB2);      ISR(0xB3);
ISR(0xB4);      ISR(0xB5);      ISR(0xB6);      ISR(0xB7);
ISR(0xB8);      ISR(0xB9);      ISR(0xBA);      ISR(0xBB);
ISR(0xBC);      ISR(0xBD);      ISR(0xBE);      ISR(0xBF);
ISR(0xC0);      ISR(0xC1);      ISR(0xC2);      ISR(0xC3);
ISR(0xC4);      ISR(0xC5);      ISR(0xC6);      ISR(0xC7);
ISR(0xC8);      ISR(0xC9);      ISR(0xCA);      ISR(0xCB);
ISR(0xCC);      ISR(0xCD);      ISR(0xCE);      ISR(0xCF);
ISR(0xD0);      ISR(0xD1);      ISR(0xD2);      ISR(0xD3);
ISR(0xD4);      ISR(0xD5);      ISR(0xD6);      ISR(0xD7);
ISR(0xD8);      ISR(0xD9);      ISR(0xDA);      ISR(0xDB);
ISR(0xDC);      ISR(0xDD);      ISR(0xDE);      ISR(0xDF);
ISR(0xE0);      ISR(0xE1);      ISR(0xE2);      ISR(0xE3);
ISR(0xE4);      ISR(0xE5);      ISR(0xE6);      ISR(0xE7);
ISR(0xE8);      ISR(0xE9);      ISR(0xEA);      ISR(0xEB);
ISR(0xEC);      ISR(0xED);      ISR(0xEE);      ISR(0xEF);
ISR(0xF0);      ISR(0xF1);      ISR(0xF2);      ISR(0xF3);
ISR(0xF4);      ISR(0xF5);      ISR(0xF6);      ISR(0xF7);
ISR(0xF8);      ISR(0xF9);      ISR(0xFA);      ISR(0xFB);
ISR(0xFC);      ISR(0xFD);      ISR(0xFE);      ISR(0xFF);

// STUB TABLE

    .globl IDT_ISR_STUBTABLE
    .data

IDT_ISR_STUBTABLE:
    .long   __idt_isr_0x00, __idt_isr_0x01, __idt_isr_0x02, __idt_isr_0x03
    .long   __idt_isr_0x04, __idt_isr_0x05, __idt_isr_0x06, __idt_isr_0x07
    .long   __idt_isr_0x08, __idt_isr_0x09, __idt_isr_0x0A, __idt_isr_0x0B
    .long   __idt_isr_0x0C, __idt_isr_0x0D, __idt_isr_0x0E, __idt_isr_0x0F
    .long   __idt_isr_0x10, __idt_isr_0x11, __idt_isr_0x12, __idt_isr_0x13
    .long   __idt_isr_0x14, __idt_isr_0x15, __idt_isr_0x16, __idt_isr_0x17
    .long   __idt_isr_0x18, __idt_isr_0x19, __idt_isr_0x1A, __idt_isr_0x1B
    .long   __idt_isr_0x1C, __idt_isr_0x1D, __idt_isr_0x1E, __idt_isr_0x1F
    .long   __idt_isr_0x20, __idt_isr_0x21, __idt_isr_0x22, __idt_isr_0x23
    .long   __idt_isr_0x24, __idt_isr_0x25, __idt_isr_0x26, __idt_isr_0x27
    .long   __idt_isr_0x28, __idt_isr_0x29, __idt_isr_0x2A, __idt_isr_0x2B
    .long   __idt_isr_0x2C, __idt_isr_0x2D, __idt_isr_0x2E, __idt_isr_0x2F
    .long   __idt_isr_0x30, __idt_isr_0x31, __idt_isr_0x32, __idt_isr_0x33
    .long   __idt_isr_0x34, __idt_isr_0x35, __idt_isr_0x36, __idt_isr_0x37
    .long   __idt_isr_0x38, __idt_isr_0x39, __idt_isr_0x3A, __idt_isr_0x3B
    .long   __idt_isr_0x3C, __idt_isr_0x3D, __idt_isr_0x3E, __idt_isr_0x3F
    .long   __idt_isr_0x40, __idt_isr_0x41, __idt_isr_0x42, __idt_isr_0x43
    .long   __idt_isr_0x44, __idt_isr_0x45, __idt_isr_0x46, __idt_isr_0x47
    .long   __idt_isr_0x48, __idt_isr_0x49, __idt_isr_0x4A, __idt_isr_0x4B
    .long   __idt_isr_0x4C, __idt_isr_0x4D, __idt_isr_0x4E, __idt_isr_0x4F
    .long   __idt_isr_0x50, __idt_isr_0x51, __idt_isr_0x52, __idt_isr_0x53
    .long   __idt_isr_0x54, __idt_isr_0x55, __idt_isr_0x56, __idt_isr_0x57
    .long   __idt_isr_0x58, __idt_isr_0x59, __idt_isr_0x5A, __idt_isr_0x5B
    .long   __idt_isr_0x5C, __idt_isr_0x5D, __idt_isr_0x5E, __idt_isr_0x5F
    .long   __idt_isr_0x60, __idt_isr_0x61, __idt_isr_0x62, __idt_isr_0x63
    .long   __idt_isr_0x64, __idt_isr_0x65, __idt_isr_0x66, __idt_isr_0x67
    .long   __idt_isr_0x68, __idt_isr_0x69, __idt_isr_0x6A, __idt_isr_0x6B
    .long   __idt_isr_0x6C, __idt_isr_0x6D, __idt_isr_0x6E, __idt_isr_0x6F
    .long   __idt_isr_0x70, __idt_isr_0x71, __idt_isr_0x72, __idt_isr_0x73
    .long   __idt_isr_0x74, __idt_isr_0x75, __idt_isr_0x76, __idt_isr_0x77
    .long   __idt_isr_0x78, __idt_isr_0x79, __idt_isr_0x7A, __idt_isr_0x7B
    .long   __idt_isr_0x7C, __idt_isr_0x7D, __idt_isr_0x7E, __idt_isr_0x7F
    .long   __idt_isr_0x80, __idt_isr_0x81, __idt_isr_0x82, __idt_isr_0x83
    .long   __idt_isr_0x84, __idt_isr_0x85, __idt_isr_0x86, __idt_isr_0x87
    .long   __idt_isr_0x88, __idt_isr_0x89, __idt_isr_0x8A, __idt_isr_0x8B
    .long   __idt_isr_0x8C, __idt_isr_0x8D, __idt_isr_0x8E, __idt_isr_0x8F
    .long   __idt_isr_0x90, __idt_isr_0x91, __idt_isr_0x92, __idt_isr_0x93
    .long   __idt_isr_0x94, __idt_isr_0x95, __idt_isr_0x96, __idt_isr_0x97
    .long   __idt_isr_0x98, __idt_isr_0x99, __idt_isr_0x9A, __idt_isr_0x9B
    .long   __idt_isr_0x9C, __idt_isr_0x9D, __idt_isr_0x9E, __idt_isr_0x9F
    .long   __idt_isr_0xA0, __idt_isr_0xA1, __idt_isr_0xA2, __idt_isr_0xA3
    .long   __idt_isr_0xA4, __idt_isr_0xA5, __idt_isr_0xA6, __idt_isr_0xA7
    .long   __idt_isr_0xA8, __idt_isr_0xA9, __idt_isr_0xAA, __idt_isr_0xAB
    .long   __idt_isr_0xAC, __idt_isr_0xAD, __idt_isr_0xAE, __idt_isr_0xBF
    .long   __idt_isr_0xB0, __idt_isr_0xB1, __idt_isr_0xB2, __idt_isr_0xB3
    .long   __idt_isr_0xB4, __idt_isr_0xB5, __idt_isr_0xB6, __idt_isr_0xB7
    .long   __idt_isr_0xB8, __idt_isr_0xB9, __idt_isr_0xBA, __idt_isr_0xBB
    .long   __idt_isr_0xBC, __idt_isr_0xBD, __idt_isr_0xBE, __idt_isr_0xCF
    .long   __idt_isr_0xC0, __idt_isr_0xC1, __idt_isr_0xC2, __idt_isr_0xC3
    .long   __idt_isr_0xC4, __idt_isr_0xC5, __idt_isr_0xC6, __idt_isr_0xC7
    .long   __idt_isr_0xC8, __idt_isr_0xC9, __idt_isr_0xCA, __idt_isr_0xCB
    .long   __idt_isr_0xCC, __idt_isr_0xCD, __idt_isr_0xCE, __idt_isr_0xDF
    .long   __idt_isr_0xD0, __idt_isr_0xD1, __idt_isr_0xD2, __idt_isr_0xD3
    .long   __idt_isr_0xD4, __idt_isr_0xD5, __idt_isr_0xD6, __idt_isr_0xD7
    .long   __idt_isr_0xD8, __idt_isr_0xD9, __idt_isr_0xDA, __idt_isr_0xDB
    .long   __idt_isr_0xDC, __idt_isr_0xDD, __idt_isr_0xDE, __idt_isr_0xEF
    .long   __idt_isr_0xE0, __idt_isr_0xE1, __idt_isr_0xE2, __idt_isr_0xE3
    .long   __idt_isr_0xE4, __idt_isr_0xE5, __idt_isr_0xE6, __idt_isr_0xE7
    .long   __idt_isr_0xE8, __idt_isr_0xE9, __idt_isr_0xEA, __idt_isr_0xEB
    .long   __idt_isr_0xEC, __idt_isr_0xED, __idt_isr_0xEE, __idt_isr_0xEF
    .long   __idt_isr_0xF0, __idt_isr_0xF1, __idt_isr_0xF2, __idt_isr_0xF3
    .long   __idt_isr_0xF4, __idt_isr_0xF5, __idt_isr_0xF6, __idt_isr_0xF7
    .long   __idt_isr_0xF8, __idt_isr_0xF9, __idt_isr_0xFA, __idt_isr_0xFB
    .long   __idt_isr_0xFC, __idt_isr_0xFD, __idt_isr_0xFE, __idt_isr_0xFF
